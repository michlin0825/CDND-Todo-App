{"map":"{\"version\":3,\"sources\":[\"src/lambda/http/generateUploadUrl.js\"],\"names\":[\"e\",\"a\",\"i\",\"exports\",\"modules\",\"installedModules\",\"__webpack_require__\",\"moduleId\",\"module\",\"l\",\"call\",\"m\",\"c\",\"d\",\"name\",\"getter\",\"o\",\"Object\",\"defineProperty\",\"enumerable\",\"get\",\"r\",\"Symbol\",\"toStringTag\",\"value\",\"t\",\"mode\",\"__esModule\",\"ns\",\"create\",\"key\",\"bind\",\"n\",\"object\",\"property\",\"prototype\",\"hasOwnProperty\",\"p\",\"s\",\"require\",\"__webpack_exports__\",\"handler\",\"external_aws_sdk_\",\"external_aws_xray_sdk_\",\"s3Helper_S3Helper\",\"[object Object]\",\"XAWS\",\"s3\",\"S3\",\"signatureVersion\",\"region\",\"process\",\"env\",\"params\",\"Bucket\",\"IMAGES_BUCKET\",\"signedUrlExpireSeconds\",\"this\",\"todoId\",\"headObject\",\"Key\",\"promise\",\"getSignedUrl\",\"Expires\",\"err\",\"console\",\"log\",\"TodoItem\",\"uuid\",\"external_jsonwebtoken_\",\"getUserId\",\"authHeader\",\"token\",\"Error\",\"toLowerCase\",\"startsWith\",\"split\",\"getToken\",\"jwt\",\"complete\",\"payload\",\"sub\",\"external_winston_\",\"todosAccess\",\"docClient\",\"DynamoDB\",\"DocumentClient\",\"todosTable\",\"TODO_TABLE\",\"userIdIndex\",\"USER_ID_INDEX\",\"userId\",\"query\",\"TableName\",\"IndexName\",\"KeyConditionExpression\",\"ExpressionAttributeValues\",\":userId\",\"Items\",\"request\",\"newId\",\"item\",\"createdAt\",\"Date\",\"toISOString\",\"dueDate\",\"done\",\"put\",\"Item\",\"id\",\":todoId\",\"updatedTodo\",\"update\",\"UpdateExpression\",\":n\",\":d\",\":done\",\"ExpressionAttributeNames\",\"#namefield\",\"param\",\"delete\",\"apiResponseHelper\",\"statusCode\",\"items\",\"headers\",\"Access-Control-Allow-Origin\",\"body\",\"JSON\",\"stringify\",\"message\",\"logger\",\"loggerName\",\"level\",\"format\",\"json\",\"defaultMeta\",\"transports\",\"Console\",\"async\",\"event\",\"pathParameters\",\"getTodoById\",\"Count\",\"error\",\"generateErrorResponse\",\"url\",\"getPresignedUrl\",\"generateDataSuccessResponse\"],\"mappings\":\"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\"}","code":"!function(e,t){for(var r in t)e[r]=t[r]}(exports,function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,\"a\",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p=\"\",r(r.s=6)}([function(e,t){e.exports=require(\"aws-sdk\")},function(e,t){e.exports=require(\"aws-xray-sdk\")},function(e,t){e.exports=require(\"winston\")},function(e,t){e.exports=require(\"jsonwebtoken\")},function(e,t){e.exports=require(\"source-map-support/register\")},function(e,t){e.exports=require(\"uuid/v4\")},function(e,t,r){\"use strict\";r.r(t),r.d(t,\"handler\",(function(){return h}));r(4);var o=r(0),n=r(1);class s{constructor(e=n.captureAWS(o),t=new e.S3({signatureVersion:\"v4\",region:process.env.region,params:{Bucket:process.env.IMAGES_BUCKET}}),r=300){this.XAWS=e,this.s3=t,this.signedUrlExpireSeconds=r}async getTodoAttachmentUrl(e){try{return await this.s3.headObject({Bucket:process.env.IMAGES_BUCKET,Key:`${e}.png`}).promise(),this.s3.getSignedUrl(\"getObject\",{Bucket:process.env.IMAGES_BUCKET,Key:`${e}.png`,Expires:this.signedUrlExpireSeconds})}catch(e){console.log(e)}return null}getPresignedUrl(e){return this.s3.getSignedUrl(\"putObject\",{Bucket:process.env.IMAGES_BUCKET,Key:`${e}.png`,Expires:this.signedUrlExpireSeconds})}}class i{}const a=r(5);var u=r(3);function d(e){console.log(\"authHeader\",e);const t=function(e){if(!e)throw new Error(\"No authentication header\");if(!e.toLowerCase().startsWith(\"bearer \"))throw new Error(\"Invalid authentication header\");return e.split(\" \")[1]}(e),r=Object(u.decode)(t,{complete:!0});return console.log(\"jwt\",r.payload),r.payload.sub}var c=r(2);const l=new class{constructor(e=n.captureAWS(o),t=new e.DynamoDB.DocumentClient,r=process.env.TODO_TABLE,s=process.env.USER_ID_INDEX){this.XAWS=e,this.docClient=t,this.todosTable=r,this.userIdIndex=s}async getUserTodos(e){return(await this.docClient.query({TableName:this.todosTable,IndexName:this.userIdIndex,KeyConditionExpression:\"userId = :userId\",ExpressionAttributeValues:{\":userId\":e}}).promise()).Items}async createTodo(e,t){const r=a(),o=new i;return o.userId=t,o.todoId=r,o.createdAt=(new Date).toISOString(),o.name=e.name,o.dueDate=e.dueDate,o.done=!1,await this.docClient.put({TableName:this.todosTable,Item:o}).promise(),o}async getTodoById(e){return await this.docClient.query({TableName:this.todosTable,KeyConditionExpression:\"todoId = :todoId\",ExpressionAttributeValues:{\":todoId\":e}}).promise()}async updateTodo(e,t){await this.docClient.update({TableName:this.todosTable,Key:{todoId:t},UpdateExpression:\"set #namefield = :n, dueDate = :d, done = :done\",ExpressionAttributeValues:{\":n\":e.name,\":d\":e.dueDate,\":done\":e.done},ExpressionAttributeNames:{\"#namefield\":\"name\"}}).promise()}async deleteTodoById(e){const t={TableName:this.todosTable,Key:{todoId:e}};await this.docClient.delete(t).promise()}},p=new class{generateDataSuccessResponse(e,t,r){return{statusCode:e,headers:{\"Access-Control-Allow-Origin\":\"*\"},body:JSON.stringify({[t]:r})}}generateEmptySuccessResponse(e){return{statusCode:e,headers:{\"Access-Control-Allow-Origin\":\"*\"},body:null}}generateErrorResponse(e,t){return{statusCode:e,headers:{\"Access-Control-Allow-Origin\":\"*\"},body:JSON.stringify({message:t})}}},g=(f=\"todos\",c.createLogger({level:\"info\",format:c.format.json(),defaultMeta:{name:f},transports:[new c.transports.Console]}));var f;const h=async e=>{const t=e.pathParameters.todoId,r=d(e.headers.Authorization),o=await l.getTodoById(t);if(0==o.Count)return g.error(`user ${r} requesting put url for non exists todo with id ${t}`),p.generateErrorResponse(400,\"TODO not exists\");if(o.Items[0].userId!==r)return g.error(`user ${r} requesting put url todo does not belong to his account with id ${t}`),p.generateErrorResponse(400,\"TODO does not belong to authorized user\");const n=(new s).getPresignedUrl(t);return p.generateDataSuccessResponse(200,\"uploadUrl\",n)}}]));","extractedComments":[]}